apiVersion: helm.fluxcd.io/v1
kind: HelmRelease
metadata:
  name: keycloak
  namespace: kube-system
  annotations:
    fluxcd.io/automated: "false"
spec:
  releaseName: keycloak
  chart:
    repository: https://codecentric.github.io/helm-charts
    name: keycloak
    version: 9.0.1
  values:
    image:
      repository: docker.io/jboss/keycloak
      tag: 11.0.0
    replicas: 3
    username: keycloak
    ingress:
      enabled: true
    serviceMonitor:
      enabled: true
    prometheusRule:
      enabled: true
    postgresql:
      enabled: true
      persistence:
        storageClass: longhorn
    extraVolumes: |
      - name: keycloak-realm
        secret:
          secretName: keycloak-realm
    extraVolumeMounts: |
      - name: keycloak-realm
        mountPath: "/realm/"
        readOnly: true
      - name: keycloak-password
        mountPath: "/secrets/keycloak-password/password"
        readOnly: true
    extraEnv: |
      - name: KEYCLOAK_IMPORT
        value: /realm/realm.json
      - name: KEYCLOAK_STATISTICS
        value: all
      - name: KEYCLOAK_USER
        value: keycloak
      - name: KEYCLOAK_PASSWORD_FILE
        value: /secrets/keycloak-password
  valueFileSecrets:
    - name: "keycloak-helm-values"
