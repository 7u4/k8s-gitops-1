---

- name: Wait for Cert-Manager to be ready
  command: "{{ item }}"
  with_items:
    - kubectl -n cert-manager wait --for condition=Available deployment/cert-manager
  register: cert_manager_status
  environment:
    KUBECONFIG: "{{ base }}/setup/kubeconfig"
  changed_when: "'deployment.apps/cert-manager condition met' in cert_manager_status.stdout"
  until: "'deployment.apps/cert-manager condition met' in cert_manager_status.stdout"
  retries: 30
  delay: 60

- name: Create Cert-Manager Certificate Request
  command: "{{ item }}"
  with_items:
    - "{{ base }}/setup/kapply.sh {{ base }}/devops/cert-manager/route53/cert-manager-letsencrypt.txt"
  register: cert_request_status
  environment:
    KUBECONFIG: "{{ base }}/setup/kubeconfig"
  changed_when: "'clusterissuer.cert-manager.io/letsencrypt-prod' in cert_request_status.stdout"
